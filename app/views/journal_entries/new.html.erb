<% content_for :title, "New journal entry" %>

<div class="flex flex-col md:flex-row min-h-screen">
  <!-- Left Rail - Journal List -->
  <div class="w-full md:w-1/4 bg-gray-100 p-4 overflow-y-auto border-r border-gray-200">
    <h2 class="text-xl font-bold mb-4">Journal Entries</h2>
    <div class="mb-4">
      <%= link_to "New Entry", new_journal_entry_path, class: "w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded text-center block" %>
    </div>
    <div id="entries-list">
      <% JournalEntry.order(created_at: :desc).each do |entry| %>
        <div class="mb-2 p-3 bg-white rounded shadow hover:shadow-md">
          <%= link_to journal_entry_path(entry) do %>
            <h3 class="font-semibold"><%= entry.title %></h3>
            <p class="text-sm text-gray-600"><%= entry.created_at.strftime("%B %d, %Y") %></p>
            <p class="text-sm text-gray-700 truncate"><%= entry.content.truncate(100) %></p>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Main Area - New Entry Form -->
  <div class="w-full md:w-2/4 p-6 overflow-y-auto">
    <div class="max-w-3xl mx-auto">
      <div class="mb-4 flex justify-between items-center">
        <h1 class="text-3xl font-bold">New Journal Entry</h1>
        <div>
          <%= link_to "Back", journal_entries_path, class: "rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50" %>
        </div>
      </div>
      
      <div class="bg-white rounded-lg shadow-lg p-6">
        <%= render "form", journal_entry: @journal_entry %>
      </div>
    </div>
  </div>

  <!-- Right Rail - AI Assistant -->
  <div class="w-full md:w-1/4 bg-gray-50 p-4 overflow-y-auto border-l border-gray-200">
    <h2 class="text-xl font-bold mb-4">AI Assistant</h2>
    <div class="bg-white rounded-lg shadow p-4">
      <p class="text-gray-700 mb-3">I'm here to help maintain your writing momentum.</p>
      <div id="ai-response" class="mt-4 p-4 bg-blue-50 rounded-lg">
        <p class="italic text-gray-600">What would you like to write about today?</p>
      </div>
      <button id="get-prompt" class="mt-4 w-full px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded">
        Get Writing Prompt
      </button>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const getPromptButton = document.getElementById('get-prompt');
    const aiResponseDiv = document.getElementById('ai-response');
    const contentTextarea = document.querySelector('textarea[name="journal_entry[content]"]');
    const titleInput = document.querySelector('input[name="journal_entry[title]"]');
    
    getPromptButton.addEventListener('click', function() {
      // Get the current content
      let entryContent = contentTextarea.value;
      
      // If there's no content but there is a title, use the title
      if (!entryContent && titleInput.value) {
        entryContent = titleInput.value;
      }
      
      // If there's still no content, use a default message
      if (!entryContent) {
        entryContent = "I'm starting a new journal entry.";
      }
      
      // Show loading state
      aiResponseDiv.innerHTML = '<p class="italic text-gray-600">Thinking...</p>';
      
      // Send content to AI assistant
      fetch('/ai_assistant/prompt?content=' + encodeURIComponent(entryContent), {
        headers: {
          'Accept': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.prompt) {
          aiResponseDiv.innerHTML = '<p class="italic text-gray-600">' + data.prompt + '</p>';
        } else {
          aiResponseDiv.innerHTML = '<p class="italic text-gray-600">I couldn\'t generate a prompt right now. Please try again later.</p>';
        }
      })
      .catch(error => {
        console.error('Error:', error);
        aiResponseDiv.innerHTML = '<p class="italic text-gray-600">There was an error connecting to the AI assistant. Please try again later.</p>';
      });
    });
  });
</script>
